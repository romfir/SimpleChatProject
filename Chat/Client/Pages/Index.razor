@page "/{chatRoomName?}"
@using Microsoft.AspNetCore.SignalR.Client
@using Chat.Shared
@using System.Linq;
@using System.Threading
@using Chat.Client.Shared.Models
@using System.Text.RegularExpressions
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

<h2>Chat room: @ChatRoomNameParsed</h2>
<div class="Site">
    <div class="Site-content" id="scroller">
        @if (_messages.Any())
        {
            @foreach (Message message in _messages) //todo edycja
            {
                <div class="@(message.User == _currentMessage.User ? "container darker" : "container")">

                    @if (message.User != _currentMessage.User)
                    {
                        <div class="user-name-right">@message.User</div>
                    }
                    <p>@message.Text</p>

                    <span class="time-right">@message.TimeStamp</span>

                    @if (message.User == _currentMessage.User)
                    {
                        <span class="oi oi-x remove-span" @onclick="_ => DeleteMessage(message.Id)" aria-hidden="true"></span>
                    }

                </div>
            }

        }
        else
        {
            <div id="container">
                <p style="font-size:100px;">&#x1F622;</p>
                <p>Currently there are no messages</p>
            </div>
        }
        @if (_typingUserNames.Any())
        {
            <p class="writing">@(TypingMessage)<span>.</span><span>.</span><span>.</span></p>
        }
        <div id="anchor"></div>
    </div>
    <footer class="bottom-footer gradientDark roundBorder" style="display: inline-block">
        <EditForm Model="@_currentMessage" OnValidSubmit="@Send">
            <DataAnnotationsValidator />

            <div class="form-group small-margin " style="display: inline-block">
                <label style="color:white" class="roundBorder">
                    User:
                    <InputText id="username" @bind-Value="_currentMessage.User" class="roundBorder" tabindex="1" autofocus />

                </label>
                <ValidationMessage For="@(() => _currentMessage.User)" />
            </div>

            <div style="display: inline-block">
                <button @onclick="ChangeConnectionStateAsync" type="button" class="roundBorder small-margin" style="display: inline-block" disabled="@(IsConnecting)" tabindex="4">
                    @if (IsConnecting)
                    {
                        <div>Connecting</div>
                    }
                    else if (IsConnected)
                    {
                        <div>Disconnect</div>
                    }
                    else
                    {
                        <div>Reconnect</div>
                    }
                </button>
            </div>

            <br />

            <div class="form-group small-margin " style="display: inline-block">
                <label style="color:white">
                    Text:
                    <InputText id="message" @onkeypress="SendWritingNotification" @bind-Value="_currentMessage.Text" class="roundBorder" tabindex="2" autocomplete="off" />
                </label>
                <ValidationMessage For="@(() => _currentMessage.Text)" />
            </div>

            <div class="form-group small-margin " style="display: inline-block">
            </div>


            <div style="display: inline-block">
                <button class="btn-primary roundBorder small-margin" disabled="@(!IsConnected)" type="submit" style="display: inline-block; width:80px;" tabindex="5">
                    <span class="oi oi-arrow-circle-right" aria-hidden="true"></span>
                </button>
            </div>

        </EditForm>

        <EditForm Model="@_newRoomModel" OnValidSubmit="@ChangeChatRoom">
            <DataAnnotationsValidator />
            <label style="color:white">
                New Chat Room Name:
                <InputText id="ChatRoom" @onkeypress="() => StateHasChanged()" @bind-Value="_newRoomModel.NewChatRoomName" class="roundBorder" tabindex="3" autocomplete="off" />
                <ValidationMessage For="@(() => _newRoomModel.NewChatRoomName)" />

            </label>
            <button class="roundBorder small-margin" disabled="@(!IsConnected)" type="submit" style="display: inline-block" tabindex="6">
                Change
            </button>
        </EditForm>
    </footer>
</div>

@code {
    [Parameter]
    public string ChatRoomName { get; set; } = null!;

    private HubConnection _hubConnection = default!;
    private List<Message> _messages = new();

    private Message _currentMessage = new();

    private CancellationTokenSource _cancellationTokenSource = new();

    private string TypingMessage
        => $"{string.Join(", ", _typingUserNames)} {(_typingUserNames.Count() == 1 ? " is " : " are ")} typing";

    private List<string> _typingUserNames = new();

    private UserNewRoomModel _newRoomModel = new();

    private bool IsConnected
        => _hubConnection.State == HubConnectionState.Connected;

    private bool IsConnecting
        => _hubConnection is null || _hubConnection.State == HubConnectionState.Connecting;

    public string ChatRoomNameParsed
        => Regex.IsMatch(ChatRoomName, @"\s") ? "\"" + ChatRoomName + "\"" : ChatRoomName;

    protected override async Task OnInitializedAsync()
    {
        ChatRoomName = ChatRoomName ?? "Global";

        _hubConnection = new HubConnectionBuilder()
                                            .WithUrl(NavigationManager.ToAbsoluteUri("/chathub"))
                                            .Build();

        _hubConnection.On<Message>("ReceiveMessage", (message) =>
        {
        //todo zamienic List<Message> na cos thread safe? Chyba jak leci duzo wiadomosci to cos sie wali
        _messages.Add(message);
            StateHasChanged();
        });

        _hubConnection.On<Guid>("DeleteMessage", (messageId) =>
        {
            if (_messages.Exists(x => x.Id == messageId))
            {
                _messages = _messages.Where(x => x.Id != messageId).ToList();
                StateHasChanged();
            }
        });

        //todo to przestalo dzialac! Dlaczego?

        _hubConnection.On<string>("UserIsWriting", (userName) =>
        {
            if (userName != _currentMessage.User)
            {
                ReceiveWritingNotification(userName);
            }
        });

        await StartAndRequestMessagesAsync();
    }

    private async Task StartAndRequestMessagesAsync()
    {
        await _hubConnection.StartAsync(_cancellationTokenSource.Token).ConfigureAwait(false);

        await _hubConnection.SendAsync("AddToGroup", ChatRoomName).ConfigureAwait(false);

        StateHasChanged();

        await RequestMessagesAsync().ConfigureAwait(false);
    }

    private async Task RequestMessagesAsync()
    {
        var stream = _hubConnection.StreamAsync<Message>("RequestMessages", ChatRoomName, _cancellationTokenSource.Token);

        _messages = new();
        await foreach (Message message in stream)
        {
            StateHasChanged();
            _messages.Add(message);
        }

        StateHasChanged();
    }

    private async void Send()
    {
        _currentMessage.TimeStamp = DateTime.Now;
        _currentMessage.Id = Guid.NewGuid();
        await _hubConnection.SendAsync("SendMessage", _currentMessage, ChatRoomName, _cancellationTokenSource.Token);

        _currentMessage.Text = "";
    }

    private async void DeleteMessage(Guid messageId)
    {
        if (IsConnected)
        {
            await _hubConnection.SendAsync("DeleteMessage", messageId, ChatRoomName, _cancellationTokenSource.Token);

            _messages = _messages.Where(x => x.Id != messageId).ToList();
            StateHasChanged();
        }
    }

    private Task ChangeConnectionStateAsync()
    {
        if (IsConnected)
        {
            _cancellationTokenSource.Cancel();
            return _hubConnection.StopAsync();
        }
        else
        {
            _cancellationTokenSource = new();
            return StartAndRequestMessagesAsync();
        }
    }

    private void SendWritingNotification()
    {
        if (IsConnected && !string.IsNullOrEmpty(_currentMessage.User))
        {
            _hubConnection.SendAsync("UserWriting", _currentMessage.User, ChatRoomName);
        }
    }

    private async void ReceiveWritingNotification(string userName)
    {
        if (!_typingUserNames.Contains(userName))
        {
            _typingUserNames.Add(userName);
            StateHasChanged();


            await Task.Delay(1000, _cancellationTokenSource.Token);

            _typingUserNames.Remove(userName);
            StateHasChanged();
        }
    }

    private async Task ChangeChatRoom()
    {
        _newRoomModel.NewChatRoomName = _newRoomModel.NewChatRoomName.Trim();
        if (ChatRoomName == _newRoomModel.NewChatRoomName)
        {
            return;
        }

        if (!IsConnected)
        {
            await _hubConnection.StartAsync(_cancellationTokenSource.Token).ConfigureAwait(false);
        }
        else
        {
            _cancellationTokenSource.Cancel();
            _cancellationTokenSource = new();
        }

        await _hubConnection.SendAsync("RemoveFromGroup", ChatRoomName, _cancellationTokenSource.Token).ConfigureAwait(false);

        ChatRoomName = _newRoomModel.NewChatRoomName;
        StateHasChanged();

        await _hubConnection.SendAsync("AddToGroup", ChatRoomName, _cancellationTokenSource.Token).ConfigureAwait(false);

        await RequestMessagesAsync().ConfigureAwait(false);
    }

    public async ValueTask DisposeAsync()
    {
        _cancellationTokenSource.Cancel();

        await _hubConnection.DisposeAsync();
    }
}
